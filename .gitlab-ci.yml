# GitLab CI/CD Pipeline for Cipher Password Manager
# Multi-platform build and test automation

stages:
  - build
  - test
  - security
  - release

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# ============================================================================
# BUILD STAGE - Compile on different platforms and compilers
# ============================================================================

build:gcc:linux:
  stage: build
  image: gcc:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libssl-dev make
  script:
    - echo "Building with GCC on Linux..."
    - make clean
    - make CC=gcc
    - ls -lh bin/
  artifacts:
    paths:
      - bin/cipher
    expire_in: 1 hour
  tags:
    - docker

build:clang:linux:
  stage: build
  image: silkeh/clang:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libssl-dev make
  script:
    - echo "Building with Clang on Linux..."
    - make clean
    - make CC=clang
    - ls -lh bin/
  artifacts:
    paths:
      - bin/cipher
    expire_in: 1 hour
  tags:
    - docker
  allow_failure: false

# ============================================================================
# TEST STAGE - Basic functionality tests
# ============================================================================

test:compilation:
  stage: test
  image: gcc:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libssl-dev make
  script:
    - echo "Testing compilation warnings..."
    - make clean
    - make CFLAGS="-Wall -Wextra -Werror -std=c11"
  tags:
    - docker

test:static-analysis:
  stage: test
  image: gcc:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libssl-dev make cppcheck
  script:
    - echo "Running static analysis with cppcheck..."
    - cppcheck --enable=all --suppress=missingIncludeSystem src/ 2>&1 | tee cppcheck-report.txt
    - echo "Static analysis completed"
  artifacts:
    paths:
      - cppcheck-report.txt
    expire_in: 1 week
  tags:
    - docker
  allow_failure: true

# ============================================================================
# SECURITY STAGE - Security checks
# ============================================================================

security:dependencies:
  stage: security
  image: gcc:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq openssl
  script:
    - echo "Checking OpenSSL version..."
    - openssl version -a
    - echo "Security check completed"
  tags:
    - docker
  only:
    - main
    - merge_requests
  allow_failure: true

# ============================================================================
# RELEASE STAGE - Build optimized binaries for releases
# ============================================================================

release:linux:amd64:
  stage: release
  image: gcc:latest
  before_script:
    - apt-get update -qq
    - apt-get install -y -qq libssl-dev make
  script:
    - echo "Building release for Linux AMD64..."
    - make clean
    - make release
    - mv bin/cipher bin/cipher-linux-amd64
    - ls -lh bin/
  artifacts:
    paths:
      - bin/cipher-linux-amd64
    expire_in: 1 year
  tags:
    - docker
  only:
    - tags
    - /^v.*$/
    - /^hotfix-v.*$/

release:create-notes:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git
  script:
    - echo "Creating release notes for $CI_COMMIT_TAG"
    - echo "# Release $CI_COMMIT_TAG" > RELEASE_NOTES.md
    - echo "" >> RELEASE_NOTES.md
    - echo "## Changes" >> RELEASE_NOTES.md
    - git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> RELEASE_NOTES.md || echo "- Initial release" >> RELEASE_NOTES.md
    - cat RELEASE_NOTES.md
  artifacts:
    paths:
      - RELEASE_NOTES.md
    expire_in: 1 year
  tags:
    - docker
  only:
    - tags
    - /^v.*$/
    - /^hotfix-v.*$/
